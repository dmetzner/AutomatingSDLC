{% extends 'Default/base.html.twig' %}

{% block head %}
  <link rel="stylesheet" href="{{ asset('css/'~theme()~'/profile.css') }}" media="screen"/>
{% endblock %}

{% block body %}

  <div class="row no-gutters profile">
    <div class="col-4 col-md-2 avatar-container mt-2 pr-3">
      <img alt="user-image" id="user-image" class="img-fluid round"
           src="{% if profile.avatar is not empty %}{{ profile.avatar }}{% else %}{{ asset('images/default/avatar_default.png') }}{% endif %}"/>
    </div>

    <div id="user-information" class="col-8 mt-2 user-info d-flex flex-column justify-content-between">
      <div>
        <h1 id="profile-header" class="h4">
          {{ profile.username }}
        </h1>
        <span class="d-block">
          <strong>
            {{ "profile.amountOfPrograms"|trans({}, "catroweb") }}:
          </strong>
          {{ program_count }}
        </span>
        <span class="d-block">
          <i class="fas fa-users"></i>
          <strong>
            {{ "profile.follower"|trans({}, "catroweb") }}:
          </strong>
          {{ follower_count }}
          {% if app.user != null and app.user.hasFollower(profile) %}
            <small class="text-muted text-uppercase">
              <i class="fas fa-check"></i> {{ "follower.followsMe"|trans({}, "catroweb") }}
            </small>
          {% endif %}
        </span>
        {% if country %}
          <span class="d-block">
            <i class="fas fa-globe-africa"></i>
            <strong>
              {{ "country"|trans({}, "catroweb") }}:
            </strong>
            {{ country }}
          </span>
        {% endif %}
      </div>


      <div id="follow-btn" class="follow-button-container follow-button w-100 mt-3">
        {% if app.user != null and app.user.id != profile.id %}
          <button class="btn btn-outline-primary profile-follows mt-0 ml-auto"
                  style="{{ profile.hasFollower(app.user) ? 'display: block' : 'display:none' }}"
                  onclick="followers.unfollow('{{ profile.id }}','{{ profile.username }}')">
            {{ 'follower.follows'|trans({}, 'catroweb') }}
          </button>
          <button class="btn btn-primary profile-follow mt-0 ml-auto"
                  style="{{ profile.hasFollower(app.user) ? 'display: none' : 'display:block' }}"
                  onclick="followers.follow('{{ profile.id }}')">
            {{ 'follower.follow'|trans({}, 'catroweb') }}
          </button>
        {% endif %}
        {% if app.user == null %}
          <button class="btn btn-primary profile-follow mt-0 mt-auto"
                  onclick="followers.follow('{{ profile.id }}')">
            {{ 'follower.follow'|trans({}, 'catroweb') }}
          </button>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row mt-3">
    <div class="catro-tabs w-100">
      <ul class="nav nav-tabs nav-fill" id="tabs-tab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="projects-tab" data-toggle="tab" href="#projects-section"
             aria-controls="projects-section" aria-selected="true"
             role="tab">{{ "profile.programs"|trans({}, "catroweb") }}</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="follows-tab" data-toggle="tab" href="#following-section"
             aria-controls="following-section" aria-selected="true"
             role="tab"> {{ 'follower.follows'|trans({}, 'catroweb') }}</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="follower-tab" data-toggle="tab" href="#follower-section"
             aria-controls="follower-section"
             aria-selected="false"
             role="tab"> {{ 'follower.followers'|trans({}, 'catroweb') }}</a>
        </li>
      </ul>
    </div>
  </div>

  <div class="tab-content mt-4" id="tabs-tabContent">
    <div id="projects-section" class="tab-pane fade show active" role="tabpanel" aria-labelledby="projects-tab">
      <div id="user-programs">
        <div class="programs"></div>
      </div>
    </div>

    <div id="following-section" class="tab-pane fade show" role="tabpanel" aria-labelledby="follows-tab">
      <div id="no-following" class="text-center mb-5 {{ following_list is empty ? 'd-block' : 'd-none' }}">
        {{ "follower.noOtherFollowing"|trans({}, "catroweb") }}
      </div>

      <div id="following-cards" class="mb-5">
        {% for followsUser in following_list %}
          <div id="following-{{ followsUser.id }}" class="single-following my-3">
            {% include 'UserManagement/Followers/follower-item.html.twig' with {'user': followsUser} only %}
          </div>
        {% endfor %}
      </div>
    </div>

    <div id="follower-section" class="tab-pane fade" role="tabpanel" aria-labelledby="follower-tab">
      <div id="no-followers" class="text-center mb-5 {{ followers_list is empty ? 'd-block' : 'd-none' }}">
        {{ "follower.noOtherFollowers"|trans({}, "catroweb") }}
      </div>

      <div id="follower-cards" class="mb-5">
        {% for followerUser in followers_list %}
          <div id="followers-{{ followerUser.id }}" class="single-follower my-3">
            {% include 'UserManagement/Followers/follower-item.html.twig' with {'user': followerUser} only %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

{% endblock %}

{% block js %}
  <script>
    let programs = new ProjectLoader('#user-programs', '{{ path('api_user_programs') }}')
    programs.initProfile('{{ profile.id }}')
    $(document).on('click', '.program', function () {
      let clicked_program_id = this.id.replace('program-', '')
      this.className += ' visited-program'
      let stored_visits      = sessionStorage.getItem('visits')
      if (!stored_visits) {
        let new_visits = [clicked_program_id]
        sessionStorage.setItem('visits', JSON.stringify(new_visits))
      } else {
        let parsed_visits = JSON.parse(stored_visits)
        if (!($.inArray(clicked_program_id, parsed_visits) >= 0)) {
          parsed_visits.push(clicked_program_id)
          sessionStorage.setItem('visits', JSON.stringify(parsed_visits))
        }
      }
    })
  </script>

  <script src="{{ asset('js/Follower.min.js') }}"></script>
  <script>
    let followers = new Follower("{{ url('unfollow') }}", "{{ url('follow') }}",
      "{{ "somethingWentWrong"|trans({}, "catroweb") }}", "{{ "followError"|trans({}, "catroweb") }}",
      "{{ "unfollowError"|trans({}, "catroweb") }}")
  </script>
{% endblock %}
